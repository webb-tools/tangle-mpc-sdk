"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRuntimeVersionViaWs = exports.getRpcMethodsViaWs = exports.getMetadataViaWs = void 0;
const decorateMethod_1 = require("@polkadot/api/promise/decorateMethod");
const x_ws_1 = require("@polkadot/x-ws");
async function getWsData(endpoint, method) {
    return new Promise((resolve, reject) => {
        const tracker = (0, decorateMethod_1.promiseTracker)(resolve, reject);
        try {
            const websocket = new x_ws_1.WebSocket(endpoint);
            websocket.onclose = (event) => {
                if (event.code !== 1000) {
                    tracker.reject(new Error(`disconnected, code: '${event.code}' reason: '${event.reason}'`));
                }
            };
            websocket.onerror = (event) => {
                tracker.reject(new Error(`WebSocket error:: ${JSON.stringify(event)}`));
            };
            websocket.onopen = () => {
                console.log('connected');
                websocket.send(`{"id":"1","jsonrpc":"2.0","method":"${method}","params":[]}`);
            };
            websocket.onmessage = (message) => {
                try {
                    tracker.resolve(JSON.parse(message.data).result);
                }
                catch (error) {
                    tracker.reject(error);
                }
                websocket.close();
            };
        }
        catch (error) {
            tracker.reject(error);
        }
    });
}
async function getMetadataViaWs(endpoint) {
    return getWsData(endpoint, 'state_getMetadata');
}
exports.getMetadataViaWs = getMetadataViaWs;
async function getRpcMethodsViaWs(endpoint) {
    const result = await getWsData(endpoint, 'rpc_methods');
    return result.methods;
}
exports.getRpcMethodsViaWs = getRpcMethodsViaWs;
async function getRuntimeVersionViaWs(endpoint) {
    const result = await getWsData(endpoint, 'state_getRuntimeVersion');
    return result.apis;
}
exports.getRuntimeVersionViaWs = getRuntimeVersionViaWs;
